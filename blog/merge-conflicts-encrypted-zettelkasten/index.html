<!DOCTYPE html>
<html>
  <head id="head">
    <meta charset="UTF-8">
    <meta name="description" content="@renerocksai - personal website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@renerocksai">
    <meta name="twitter:author" content="@renerocksai">
    <meta name="twitter:description" content="@renerocksai - personal website">
    <meta name="twitter:title" content="Handling merges and conflicts in an encrypted GitHub Zettelkasten  | @renerocksai">
    <meta name="twitter:image" content="https://renerocks.ai/reneglasses.png">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Handling merges and conflicts in an encrypted GitHub Zettelkasten  | @renerocksai">
    <meta property="og:image" content="https://renerocks.ai/reneglasses.png">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title id="title">
      Handling merges and conflicts in an encrypted GitHub Zettelkasten 
      - @renerocksai
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/main.css">
    <link rel="stylesheet" type="text/css" href="/highlight.css">
    
  <link type="text/css" rel="stylesheet" href="/term-highlight.css">
  <style>
    #docs {
        h1, h2, h3, h4 {
            text-align: left;
            a {
                color: black;
                text-decoration: none;
            }
        }
        @media (prefers-color-scheme:dark) {
          h1, h2, h3, h4 {
            a {
              color: white;
            }
          }
        }

        h2 {
            font-size: 1.5rem;
            border-bottom: 1px dashed #aaa;
            margin-top: 2em;
            a:hover::after {
                content: ' #';
            }
        }

        h3 {
            font-size: 1.5rem;
            a:hover::after {
                content: ' ##';
            }
        }

        h4 {
            font-size: 1rem;
            a:hover::after {
                content: ' ###';
            }
        }

    }

    table {
        font-size: 0.9em;
    }
    table th {
        font-size: 1em;
    }
    table td {
        white-space: nowrap;
    }
  </style>

  </head>
  <body>
    <nav>
      <div class="navleft noupper">
        @renerocksai
      </div>
      <div class="spacer"></div>
      <button class="hamburger" aria-label="Toggle menu">
         &#9776;
        <!-- Unicode for hamburger icon (☰) -->
      </button>
      <div class="menu">
        <a href="/">Home</a>
        <a href="/blog/">Blog</a>
        <a href="/projects/">Projects</a>
        <a href="/about/">About</a>
        <a href="https://github.com/renerocksai" target="_blank">
          GitHub
        </a>
      </div>
      <div class="spacer"></div>
    </nav>
    <div id="content">
      
  <h1>Handling merges and conflicts in an encrypted GitHub Zettelkasten </h1>
  <p class="post-byline">
    <span>January 21, 2021</span>
    •
    <span>13</span>
    min read • by
    <b>renerocksai</b>
    <span></span>
  </p>
  <div id="post-description"></div>
  <div>
    <div class="toc block info">
      <h1>&nbsp;Table of Contents</h1>
      <div><ul>
<li>
<ul><li>
Installing a merge handler for git-crypt<ul><li>
Obsidian / Computer</li><li>Other systems</li><li>Android</li></ul></li><li>How to handle merges<ul><li>
Merge situations<ul><li>
Case 1: Pull fails due to uncommitted changes</li><li>Case 2: Push fails because GitHub repository is ahead</li><li>Case 3: Normal merge<ul><li>
On Android or the command line</li></ul></li><li>Case 4: Merge fails with conflict markers in affected files<ul><li>
On Android or the command line</li></ul></li></ul></li></ul></li><li>Appendix A: Testing merge</li><li>Appendix B: Future-proofing the Android scripts<ul><li>
Problem with widgets: /usr/bin/env does not exist</li><li>How and why this works</li></ul></li></ul></ul></div>
    </div>
  </div>
  <div id="docs">
    <div id="post-body"><p>Since I implemented <a href="/blog/android-sync-obsidian-encrypted-github/">an encrypted GitHub repository for my zettelkasten</a>, I was totally happy using it, suspending work on my Chromebook to resume it on my Desktop PC, later continuing on my smartphone using the excellent <a href="http://epsilonexpert.com/" target="_blank">Epsilon Notes</a> app - until I ran into a merge conflict because I had edited the same (daily) note on two devices without prior syncing.</p><p>This is when I realized, <code>git-crypt</code> does not support merging! As a consequence, it always treats conflicting files as having no difference to the local version of the main branch. Which, if you commit them, essentially leads to you always overwriting what had been pushed already with what you have locally: You will loose the remote changes.</p><p>Of course, you can avoid that. The easiest option, when encountering a merge conflict, would be to just <code>git clone</code> the GitHub repository into a different folder and then inspect the conflicting notes or using a command line or GUI diff (and merge) tool.</p><p>However, we need to fix the merge-inability of <code>git-crypt</code>. Luckily enough, there is a fix: we “just” need to add a <em>merge handler script</em> to <code>git-crypt</code>.</p><h2>Installing a merge handler for git-crypt</h2><h3>Obsidian / Computer</h3><p>I have taken the essentials of this solution from <a href="https://github.com/AGWA/git-crypt/issues/140" target="_blank">this GitHub issue</a> which looks promising. So, first we need to add to <code>.git/config</code>. In preparation for other repositories, we just create a file with these contents, name it <code>git-config-for-merge</code>, and place it in the root of our vault:</p><pre><code class="bash">
<span class="comment"># config for merge</span>
[<span class="constant">merge</span> <span class="constant">&quot;git-crypt&quot;]</span>
	<span class="constant">name</span> <span class="constant">=</span> <span class="constant">A</span> <span class="constant">custom</span> <span class="constant">merge</span> <span class="constant">driver</span> <span class="constant">used</span> <span class="constant">to</span> <span class="constant">merge</span> <span class="constant">git-crypted</span> <span class="constant">files.</span>
	<span class="constant">driver</span> <span class="constant">=</span> <span class="constant">$HOME/bin/my-merge-tool.sh</span> <span class="constant">%O</span> <span class="constant">%A</span> <span class="constant">%B</span>
	<span class="constant">recursive</span> <span class="constant">=</span> <span class="constant">binary</span>
</code></pre>
<p>At the root of the repository, our vault, we also create the script <code>my-merge-tool.sh</code>:</p><pre><code class="bash"><span class="comment">#!/usr/bin/env bash</span>
<span class="property">ancestor_decrypted</span>=<span class="string">&quot;$1__decrypt&quot;</span>
<span class="property">current_decrypted</span>=<span class="string">&quot;$2__decrypt&quot;</span>
<span class="property">other_decrypted</span>=<span class="string">&quot;$3__decrypt&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;###########################&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;# Git crypt driver called #&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;###########################&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;&quot;</span>

<span class="constant">echo</span> <span class="constant">&quot;Decrypting ancestor file...&quot;</span>
<span class="constant">cat</span> <span class="constant">$1</span> <span class="operator">|</span> <span class="constant">git-crypt</span> <span class="constant">smudge</span> <span class="operator">&gt;</span> <span class="string">&quot;${ancestor_decrypted}&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;Decrypting current file...&quot;</span>
<span class="constant">cat</span> <span class="constant">$2</span> <span class="operator">|</span> <span class="constant">git-crypt</span> <span class="constant">smudge</span> <span class="operator">&gt;</span> <span class="string">&quot;${current_decrypted}&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;Decrypting other file...&quot;</span>
<span class="constant">cat</span> <span class="constant">$3</span> <span class="operator">|</span> <span class="constant">git-crypt</span> <span class="constant">smudge</span> <span class="operator">&gt;</span> <span class="string">&quot;${other_decrypted}&quot;</span>
<span class="constant">echo</span> <span class="constant">&quot;&quot;</span>

<span class="constant">echo</span> <span class="constant">&quot;Merging ...&quot;</span>
<span class="constant">git</span> <span class="constant">merge-file</span> <span class="constant">-L</span> <span class="constant">&quot;current branch&quot;</span> <span class="constant">-L</span> <span class="constant">&quot;ancestor branch&quot;</span> <span class="constant">-L</span> <span class="constant">&quot;other branch&quot;</span> <span class="constant">&quot;${current_decrypted}&quot;</span> <span class="constant">&quot;${ancestor_decrypted}&quot;</span> <span class="constant">&quot;${other_decrypted}&quot;</span>
<span class="property">exit_code</span>=<span class="operator">$</span>?
<span class="constant">cat</span> <span class="constant">&quot;${current_decrypted}&quot;</span> <span class="operator">|</span> <span class="constant">git-crypt</span> <span class="constant">clean</span> <span class="operator">&gt;</span> <span class="operator">$</span><span class="property">2</span>

<span class="constant">echo</span> <span class="constant">&quot;Removing temporary files...&quot;</span>
<span class="constant">rm</span> <span class="constant">&quot;${other_decrypted}&quot;</span> <span class="constant">&quot;${ancestor_decrypted}&quot;</span> <span class="constant">&quot;${current_decrypted}&quot;</span>

<span class="keyword">if</span> [ <span class="string">&quot;$exit_code&quot;</span> -eq <span class="string">&quot;0&quot;</span> ]
<span class="keyword">then</span>
    <span class="constant">echo</span> <span class="constant">&quot;@@@ No conflict!&quot;</span>
<span class="keyword">else</span>
    <span class="constant">echo</span> <span class="constant">&quot;@@@ You need to solve some conflicts...&quot;</span>
<span class="keyword">fi</span>

<span class="constant">exit</span> <span class="constant">$exit_code</span>
</code></pre>
<p>And the final file we create is an installer, which we call <code>install-merge-tool.sh</code>:</p><pre><code class="bash"><span class="comment">#!/usr/bin/env bash</span>
<span class="constant">mkdir</span> <span class="constant">-p</span> <span class="constant">$HOME/bin</span>
<span class="constant">cp</span> <span class="constant">my-merge-tool.sh</span> <span class="constant">$HOME/bin/</span>
<span class="constant">chmod</span> <span class="constant">+x</span> <span class="constant">$HOME/bin/my-merge-tool.sh</span>

<span class="keyword">if</span> ! <span class="constant">grep</span> <span class="constant">my-merge-tool</span> <span class="constant">.git/config</span> <span class="operator">&gt;</span> /dev/null ; <span class="keyword">then</span>
    <span class="constant">cat</span> <span class="constant">git-config-for-merge</span> <span class="operator">&gt;&gt;</span> .git/config
    <span class="constant">echo</span> <span class="constant">&quot;git config updated&quot;</span>
<span class="keyword">else</span>
    <span class="constant">echo</span> <span class="constant">&quot;git config not updated&quot;</span>
<span class="keyword">fi</span>
</code></pre>
<p>Then we make sure it’s executable and run it:</p><pre><code class="bash"><span class="constant">$ chmod</span> <span class="constant">+x</span> <span class="constant">install-merge-tool.sh</span>
<span class="operator">$</span> <span class="constant">./install-merge-tool.sh</span>
</code></pre>
<p>This copies the merge tool into the <code>bin</code> folder of your home folder and makes sure it’s executable and updates your git config file accordingly. Unfortunately, the merge tool cannot be executed from within the root folder of the repository, since on Android, the repository has to reside in the <strong>shared</strong> folder which does not allow for executable permissions and removes them automatically.</p><p>Finally, we modify your <code>.gitattributes</code> to add a merge option at the end of each git-crypt-relevant line:</p><pre><code class="bash"><span class="constant">**.md</span> <span class="constant">filter=git-crypt</span> <span class="constant">diff=git-crypt</span> <span class="constant">merge=git-crypt</span>
<span class="constant">*/**</span> <span class="constant">filter=git-crypt</span> <span class="constant">diff=git-crypt</span> <span class="constant">merge=git-crypt</span>
</code></pre>
<p>Voila! Now we have the tooling and config in place.</p><p>One last thing: We add and push the merge tool to git:</p><ul><li>either via Obsidian push …</li><li>or manually:</li></ul><pre><code class="bash"><span class="constant">$ git</span> <span class="constant">add</span> <span class="constant">git-config-for-merge</span> <span class="constant">my-merge-tool.sh</span> <span class="constant">install-merge-tool.sh</span> <span class="constant">.gitattributes</span>
<span class="constant">$ git</span> <span class="constant">commit</span> <span class="constant">-m</span> <span class="constant">&quot;adding merge tool&quot;</span>
<span class="constant">$ git</span> <span class="constant">push</span>
</code></pre>
<p>So from now on, we’ll have it available on all other systems, same goes for <code>.gitattributes</code>. That will save us some time on other systems.</p><h3>Other systems</h3><p>Since we checked in the merge tool, we just need to pull in those changes and run the installer:</p><ul><li>via Obsidian: git pull…</li><li>or via commandline: <code>git pull</code></li></ul><p>Then we execute the merge tool installer:</p><pre><code class="bash"><span class="constant">$ sh</span> <span class="constant">install-merge-tool.sh</span>    <span class="comment"># note the sh command</span>
</code></pre>
<h3>Android</h3><p>We basically repeat what we did for Obsidian on other systems:</p><p>We open termux and type:</p><pre><code class="bash"><span class="comment"># first we pull the merge tool using the pull script</span>
<span class="operator">$</span> <span class="constant">./pull.sh</span>

<span class="comment"># change zettelkasten to the name of your working copy:</span>
<span class="constant">$ cd</span> <span class="constant">storage/shared/zettelkasten</span>
<span class="constant">$ sh</span> <span class="constant">install-merge-tool.sh</span>     <span class="comment"># note the sh command</span>
</code></pre>
<p>Note that your <code>.git</code> directory will be in a different place if your Zettlkasten folder is not named <code>zettelkasten</code>.</p><h2>How to handle merges</h2><p>There are 4 kinds of merge situations that can come up when pulling remote changes:</p><ol><li>Pull fails due to uncommitted changes</li><li>Push fails because the GitHub repository is ahead</li><li>Normal merge, where git handles everything for you</li><li>Merge fails with conflict markers in affected files</li></ol><h3>Merge situations</h3><h4>Case 1: Pull fails due to uncommitted changes</h4><p>In Obsidian, on pull, you will get the notification that “pull failed due to uncommitted changes”.</p><p>In this case, just use its “push” function to commit your local changes. Of course the push itself will fail, because you need to pull in the remote changes first.  But that doesn’t need to be an issue yet.</p><p>If the push fails:</p><h4>Case 2: Push fails because GitHub repository is ahead</h4><p>This is always the case when you change a file, like your daily note, that previously has been changed on another device, and when those changes have been pushed already. In this case, the <code>push</code> will fail and you will be asked to pull first.</p><p>This, when pulling now, is where you’ll encounter one of the other 2 scenarios.</p><h4>Case 3: Normal merge</h4><p>This happens when your changes affect different files or if you changed a file, like your daily note, in two different locations on two different devices. For example, you change the top paragraph of your daily note on your main computer and forget to push those changes. Then, on your smartphone, you change the very last paragraph and push these changes. Back on your computer, you want to push and it fails (but your local changes will be commited locally). Since you are asked to pull first, you just pull.</p><p>If you try pulling with the Obsidian git plugin now:</p><ul><li>The notification will be the normal, small <em>”… Changed n files”</em> notification</li><li>git will merge the changes and commit them</li><li>the next time you push, this merge will be pushed along with the other changes you will have made by then</li></ul><p>So all is fine!</p><h5>On Android or the command line</h5><p>On Android, when you tap the <code>pull.sh</code> homescreen widget or on the command line, if you prefer that, , you issue the <code>git pull</code> command inside your Zettelkasten folder, the following will happen:</p><p>Git will see that the changes do not conflict: It will fix your daily note for you: taking changes from the GitHub version and the local changes into account. However, git usually wants to commit these changes immediately. So it will drop you into an editor where you can edit the pre-defined commit  message:</p><pre><code>Merge branch &apos;main&apos; of github.com:your_username/zettelkasten
</code></pre><p>You can safely exit the editor, saving this message. In case you’ve been dropped into the <code>vi</code> editor, just press <code>:x</code> - all other editors will display some kind of menu.</p><p>Now you can push the combined changes with  the <code>git push</code> command.</p><h4>Case 4: Merge fails with conflict markers in affected files</h4><p>This is a tricky one since the plugin gives you no clear indication that it happened. That means:</p><p><strong>Any time a push fails, either pull from the command line or pay extra attention to the size of the pull notification! It will be large in case of a failed merge!</strong> {: .notice–danger :}</p><p>When you pull, the Obsidian git plugin will not warn you but your files will end up containing conflict markers with both conflicting version and original version.  See <a href="#appendix-a-testing-merge">Appendix A: Testing merge</a> for more information.</p><p>To actively search for conflict markers, just search for <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> in your vault.</p><p>From the appendix:</p><blockquote><p>Any conflicts can be found when searching for <code>&lt;&lt;&lt;&lt;&lt;</code>. This line is followed by the local version of the line in question. In case of multiple consecutive lines, all of them will show up here. This section is followed by the separator <code>=======</code>. After that, the remote version of the chunk in question is presented until the end marker <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code>.</p></blockquote><blockquote><p>Now you can decide how to go about these conflicting changes.</p></blockquote><h5>On Android or the command line</h5><p>Here, the pull and merge conflict situation is easier to detect: The attempt to auto-merge changes upon pulling results in a clear error message. It looks like this:</p><pre><code class="bash"><span class="comment">###########################</span>
<span class="comment"># Git crypt driver called #</span>
<span class="comment">###########################</span>

<span class="constant">Decrypting</span> <span class="constant">ancestor</span> <span class="constant">file...</span>
<span class="constant">Decrypting</span> <span class="constant">current</span> <span class="constant">file...</span>
<span class="constant">Decrypting</span> <span class="constant">other</span> <span class="constant">file...</span>

<span class="constant">Merging</span> <span class="constant">...</span>
<span class="constant">Removing</span> <span class="constant">temporary</span> <span class="constant">files...</span>
<span class="constant">@@@</span> <span class="constant">You</span> <span class="constant">need</span> <span class="constant">to</span> <span class="constant">solve</span> <span class="constant">some</span> <span class="constant">conflicts...</span>
<span class="constant">Auto-merging</span> <span class="constant">testmerge.md</span>
<span class="constant">CONFLICT</span> <span class="constant">(content)</span>: <span class="constant">Merge</span> <span class="constant">conflict</span> <span class="constant">in</span> <span class="constant">testmerge.md</span>
<span class="constant">Automatic</span> <span class="constant">merge</span> <span class="constant">failed</span>; <span class="constant">fix</span> <span class="constant">conflicts</span> <span class="constant">and</span> <span class="constant">then</span> <span class="constant">commit</span> <span class="constant">the</span> <span class="constant">result.</span>
</code></pre>
<p>At the end, in the line</p><pre><code class="bash"><span class="constant">CONFLICT</span> <span class="constant">(content)</span>: <span class="constant">Merge</span> <span class="constant">conflict</span> <span class="constant">in</span> <span class="constant">testmerge.md</span>
</code></pre>
<p>git tells you exactly which files contain conflicts. Now you just need to hunt for conflict markers inside those files, not your entire vault.</p><p>And that’s it. You see, the worst that can happen now, is: conflict markers in your notes that are easy to find. You will never loose any of your changes.</p><h2>Appendix A: Testing merge</h2><p>First, we create a new branch in our Zettelkasten, so we can play around without causing permanent damage:</p><pre><code class="bash"><span class="constant">$ git</span> <span class="constant">checkout</span> <span class="constant">-b</span> <span class="constant">mergetest</span>
</code></pre>
<p>OK, let’s create a note <code>mergetest.md</code> and push it:</p><pre><code class="bash"><span class="comment"># in your vault</span>
<span class="constant">$ echo</span> <span class="constant">&quot;this is a test&quot;</span> <span class="operator">&gt;</span> mergetest.md
<span class="constant">$ git</span> <span class="constant">add</span> <span class="constant">mergetest.md</span>
<span class="constant">$ git</span> <span class="constant">commit</span> <span class="constant">-m</span> <span class="constant">&quot;testnote from the original vault&quot;</span>
<span class="constant">$ git</span> <span class="constant">push</span> <span class="constant">-u</span> <span class="constant">origin</span> <span class="constant">mergetest</span>
</code></pre>
<p>Then, we will clone the GitHub repository into a second working copy named <code>mergetest</code>:</p><pre><code class="bash"><span class="constant">$ git</span> <span class="constant">remote</span> <span class="constant">-v</span>

<span class="comment"># now we copy one of the two &quot;git@github.com....git&quot; specifiers</span>

<span class="constant">$ cd</span> <span class="constant">some-other-folder</span>  <span class="comment"># outside of your zettelkasten/vault</span>

<span class="comment"># insert the stuff we copied between the &quot;quotation marks&quot;</span>
<span class="constant">$ git</span> <span class="constant">clone</span> <span class="constant">&quot;git@github.com...git&quot;</span> <span class="constant">mergetest</span>

<span class="comment"># unlock it</span>
<span class="constant">$ git-crypt</span> <span class="constant">unlock</span> <span class="constant">../git-crypt-key</span>

<span class="comment"># git config -- instead of the installer, we can run just this</span>
<span class="constant">$ cat</span> <span class="constant">git-config-for-merge</span> <span class="operator">&gt;&gt;</span> .git/config

<span class="comment"># switch to the mergetest branch</span>
<span class="constant">$ git</span> <span class="constant">checkout</span> <span class="constant">mergetest</span>

<span class="comment"># oh-my-zsh git config if needed</span>
<span class="constant">$ git</span> <span class="constant">config</span> <span class="constant">--add</span> <span class="constant">oh-my-zsh.hide-status</span> <span class="constant">1</span>
<span class="constant">$ git</span> <span class="constant">config</span> <span class="constant">--add</span> <span class="constant">oh-my-zsh.hide-dirty</span> <span class="constant">1</span>
</code></pre>
<p>So now it’s time to make a change in the <code>mergetest</code> vault:</p><pre><code class="bash"><span class="comment"># we modify the note</span>
<span class="constant">$ echo</span> <span class="constant">&quot;this is the replacement line&quot;</span> <span class="operator">&gt;</span> mergetest.md
</code></pre>
<p>We have just modified the note. But we didn’t commit or push it. So what happens when we change this very note in our main vault, push the change and try to pull it into our test vault? We will have a merge conflict!</p><p>So let’s try it out:</p><pre><code class="bash"><span class="comment"># in our main vault</span>
<span class="constant">$ echo</span> <span class="constant">&quot;this will create conflict&quot;</span> <span class="operator">&gt;</span> mergetest.md
<span class="constant">$ git</span> <span class="constant">add</span> <span class="constant">mergetest.md</span>
<span class="constant">$ git</span> <span class="constant">commit</span> <span class="constant">-m</span> <span class="constant">&quot;conflicting commit&quot;</span>
<span class="constant">$ git</span> <span class="constant">push</span>
</code></pre>
<p>Now let’s return to our mergetest vault and see what happens, when we pull:</p><pre><code class="bash"><span class="comment"># in the mergetest vault</span>
<span class="constant">$ git</span> <span class="constant">pull</span>
<span class="constant">...</span>
<span class="constant">Updating</span> <span class="constant">63691a6..489d5b7</span>
<span class="constant">error:</span> <span class="constant">Your</span> <span class="constant">local</span> <span class="constant">changes</span> <span class="constant">to</span> <span class="constant">the</span> <span class="constant">following</span> <span class="constant">files</span> <span class="constant">would</span> <span class="constant">be</span> <span class="constant">overwritten</span> <span class="constant">by</span> <span class="constant">merge:</span>
        <span class="constant">mergetest.md</span>
<span class="constant">Please</span> <span class="constant">commit</span> <span class="constant">your</span> <span class="constant">changes</span> <span class="constant">or</span> <span class="constant">stash</span> <span class="constant">them</span> <span class="constant">before</span> <span class="constant">you</span> <span class="constant">merge.</span>
<span class="constant">Aborting</span>
</code></pre>
<p>And voila! We get a serious error message 🙂!</p><p>We can look at the differences:</p><pre><code class="bash"><span class="constant">$ git</span> <span class="constant">diff</span>
<span class="constant">index</span> <span class="constant">8615b53..385ee0f</span> <span class="constant">100644</span>
<span class="constant">---</span> <span class="constant">a/mergetest.md</span>
<span class="constant">+++</span> <span class="constant">b/mergetest.md</span>
<span class="constant">@@</span> <span class="constant">-1</span> <span class="constant">+1</span> <span class="constant">@@</span>
<span class="constant">-this</span> <span class="constant">is</span> <span class="constant">a</span> <span class="constant">test</span>
<span class="constant">+this</span> <span class="constant">is</span> <span class="constant">the</span> <span class="constant">replacement</span> <span class="constant">line</span>
</code></pre>
<p>OK, so far this is working. But this just prevents us from pulling and doesn’t do any harm.</p><p>Let’s commit in the mergetest branch and try to pull:</p><pre><code class="bash"><span class="comment"># in the mergetest branch</span>
<span class="constant">$ git</span> <span class="constant">add</span> <span class="constant">mergetest.md</span>
<span class="constant">$ git</span> <span class="constant">commit</span> <span class="constant">-m</span> <span class="constant">&quot;uh oh&quot;</span>
<span class="constant">$ git</span> <span class="constant">pull</span>

<span class="comment">###########################</span>
<span class="comment"># Git crypt driver called #</span>
<span class="comment">###########################</span>

<span class="constant">Decrypting</span> <span class="constant">ancestor</span> <span class="constant">file...</span>
<span class="constant">Decrypting</span> <span class="constant">current</span> <span class="constant">file...</span>
<span class="constant">Decrypting</span> <span class="constant">other</span> <span class="constant">file...</span>

<span class="constant">Merging</span> <span class="constant">...</span>
<span class="constant">Removing</span> <span class="constant">temporary</span> <span class="constant">files...</span>
<span class="constant">@@@</span> <span class="constant">You</span> <span class="constant">need</span> <span class="constant">to</span> <span class="constant">solve</span> <span class="constant">some</span> <span class="constant">conflicts...</span>
<span class="constant">Auto-merging</span> <span class="constant">mergetest.md</span>
<span class="constant">CONFLICT</span> <span class="constant">(content)</span>: <span class="constant">Merge</span> <span class="constant">conflict</span> <span class="constant">in</span> <span class="constant">mergetest.md</span>
<span class="constant">Automatic</span> <span class="constant">merge</span> <span class="constant">failed</span>; <span class="constant">fix</span> <span class="constant">conflicts</span> <span class="constant">and</span> <span class="constant">then</span> <span class="constant">commit</span> <span class="constant">the</span> <span class="constant">result.</span>
</code></pre>
<p>WOW! We can see, the <code>git-crypt</code> merge tool was called!</p><p>So let’s examine <code>mergetest.md</code>:</p><pre><code class="bash"><span class="constant">$ cat</span> <span class="constant">mergetest.md</span>
<span class="constant">&lt;&lt;&lt;&lt;&lt;&lt;&lt; current</span> <span class="constant">branch</span>
<span class="constant">this</span> <span class="constant">is</span> <span class="constant">the</span> <span class="constant">replacement</span> <span class="constant">line</span>
<span class="constant">=======</span>
<span class="constant">this</span> <span class="constant">will</span> <span class="constant">create</span> <span class="constant">conflict</span>
<span class="constant">&gt;&gt;&gt;&gt;&gt;&gt;&gt; other</span> <span class="constant">branch</span>
</code></pre>
<p>Yayyy! 🥳 This is exactly what we wanted! It may look cryptic but git tells us exactly what is going on:</p><p>Any conflicts can be found when searching for <code>&lt;&lt;&lt;&lt;&lt;</code>. This line is followed by the local version of the line in question. In case of multiple consecutive lines, all of them will show up here. This section is followed by the separator <code>=======</code>. After that, the remote version of the chunk in question is presented until the end marker <code>&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code>.</p><p>Now you can decide how to go about these conflicting changes.</p><p><strong>At the end, don’t forget to switch back to the <code>main</code> branch:</strong> {: .notice–danger :}</p><pre><code class="bash"><span class="comment"># in your Zettelkasten folder (Obsidian vault)</span>
<span class="constant">$ git</span> <span class="constant">checkout</span> <span class="constant">main</span>
<span class="constant">$ git</span> <span class="constant">branch</span> <span class="constant">-d</span> <span class="constant">mergetest</span>
<span class="constant">$ git</span> <span class="constant">push</span> <span class="constant">origin</span> <span class="constant">--delete</span> <span class="constant">mergetest</span>
</code></pre>
<p>And all your tests are gone.</p><h2>Appendix B: Future-proofing the Android scripts</h2><p>Here, we will tidy up our scripts - so they become cross platform friendly - and we don’t get any surprises if we replace them by some other script we developed for another system.</p><h3>Problem with widgets: /usr/bin/env does not exist</h3><p>So consider <code>log.sh</code>:</p><pre><code class="bash"><span class="constant">source</span> <span class="constant">$HOME/repo.conf</span>
<span class="constant">cd</span> <span class="constant">$HOME/storage/shared/$</span><span class="constant">GH\_REPO</span>
<span class="constant">git</span> <span class="constant">log</span>
<span class="constant">cd</span> <span class="constant">$HOME</span>
<span class="constant">bash</span> <span class="constant">-c</span> <span class="constant">&quot;read -t 5 -n 1&quot;</span>
</code></pre>
<p>Ideally, we’d like to prefix that with a shebang line: <code>#!/usr/bin/env sh</code>:</p><pre><code class="bash"><span class="comment">#!/usr/bin/env sh</span>
<span class="constant">source</span> <span class="constant">$HOME/repo.conf</span>
<span class="constant">cd</span> <span class="constant">$HOME/storage/shared/$</span><span class="constant">GH\_REPO</span>
<span class="constant">git</span> <span class="constant">log</span>
<span class="constant">cd</span> <span class="constant">$HOME</span>
<span class="constant">bash</span> <span class="constant">-c</span> <span class="constant">&quot;read -t 5 -n 1&quot;</span>
</code></pre>
<p>Eventhough our script runs on the command line when we invoke it with</p><pre><code class="bash"><span class="operator">$</span> <span class="constant">./log.sh</span>
</code></pre>
<p>it now stopped working when tapped on the homescreen, thanks to the “shebang line”.</p><p>So what we do, is: We create a wrapper called <code>log</code> in <code>.shortcuts/</code> that just invokes <code>log.sh</code>, and remove the link to <code>log.sh</code>, so that <code>log</code> can become our new shortcut.</p><p><a href="#how-and-why-this-works">How and why this works</a> goes into more details about how and why the solution works. {: .notice–warning :}</p><p>This is how we do it:</p><pre><code class="bash"><span class="constant">$ cd</span>

<span class="comment"># remove the link</span>
<span class="constant">$ rm</span> <span class="constant">.shortcuts/log.sh</span>

<span class="comment"># create the wrapper</span>
<span class="constant">$ echo</span> <span class="constant">&apos;$HOME/log.sh&apos;</span> <span class="operator">&gt;</span> .shortcuts/log
<span class="constant">$ chmod</span> <span class="constant">+x</span> <span class="constant">.shortcuts/log</span>
</code></pre>
<p>On our Android home screen we remove <code>log.sh</code>, and add <code>log</code> via the termux widget.</p><p>We repeat the same procedure for <code>pull.sh</code> and <code>push.sh</code>.</p><h3>How and why this works</h3><p>The source of the solution is: <a href="https://github.com/termux/termux-exec" target="_blank">termux-exec</a>.</p><p>According to <a href="https://wiki.termux.com/wiki/Termux-exec" target="_blank">the termux wiki</a>, <code>termux-exec</code> is already installed on current versions of termux.</p><p>How does termux-exec do that? It installs a wrapper to the <a href="https://man7.org/linux/man-pages/man2/execve.2.html" target="_blank">execve()</a> system call that translates all paths to <code>/bin/</code> and <code>/usr/bin/</code> to their termux counterparts.</p><p>How <strong>can</strong> it do that? With the <code>LD_PRELOAD</code> mechanism: You can set the environment variable <code>LD_PRELOAD</code> to one or more libraries you want to load <strong>before</strong> all others. This can be used to selectively override functions in other shared objects. In the case of <code>termux-exec</code>, the <code>execve()</code> system call is overridden. When the termux console starts, it automatically checks for an <code>LD_PRELOAD</code> override configuration - which it finds since <code>termux-exec</code> is installed.</p><p>Why do our wrapper scripts work in combination with the homescreen widgets? Apparently, the widget executes our scripts differently than the termux shell in the console does: The <code>LD_PRELOAD</code> is not in effect. However, once our wrapper script is running, <strong>the shell</strong>, not a widget, executes the script named in the wrapper - this is much more similar to the command line invocation, and the <code>LD_PRELOAD</code> trick works again.</p></div>
  </div>
  <hr>
  <div id="prev-next">
    <span>
      <a href="/blog/android-sync-obsidian-encrypted-github/">←
        <span>Syncing your Obsidian vault to Android via an encrypted GitHub repository</span></a>
    </span>
    <span>&nbsp; • &nbsp;</span>
    <span>
      <a href="/blog/jj-one-week-in/"><span>Jujutsu (version control) - one week in</span>
        →</a>
    </span>
    <small>&nbsp; or &nbsp;</small>
    <small>
      <a href="/">Back to the Homepage</a>
    </small>
  </div>

    </div>
    <footer id="footer">
      
    </footer>
    <script>
      document.querySelector('.hamburger').addEventListener('click', function() {
        document.querySelector('.menu').classList.toggle('active');
        console.log("CLICK");
    });
    </script>
  </body>
</html>
